@page "/"
@page "/GenerateLabels"
@using System.Text.RegularExpressions
@using System.Xml.Serialization
@using DPD_App.Models
@inject AppState AppState

<PageTitle>GenerateLabels</PageTitle>

<MudStack Row="true" Justify="Justify.SpaceBetween" Class="mb-4">
    <h1 class="pa-1 pb-2">Generate Labels</h1>
    <MudStack Row="true">
        <MudTabs Elevation="2" Rounded="true" @bind-ActivePanelIndex="ActiveMode">
            <MudTabPanel Text="Simple" />
            <MudTabPanel Text="Extended" />
        </MudTabs>
        <MudIconButton Disabled="@_refreshing" Class="mb-2 px-2" Icon="@Icons.Material.Filled.Refresh" Color="Color.Primary" OnClick="RefreshData" Variant="Variant.Filled" Size="Size.Large">
        </MudIconButton>
    </MudStack>
</MudStack>

<MudGrid @onkeydown="OnEnter">
<MudItem xs="12">
    <MudPanel>
        <MudStack Row="true">
            <MudTextField T="string" Value="profileFromTextBoxes.Login" Label="Login" Variant="Variant.Outlined" Margin="Margin.Dense" ValueChanged="LoginChanged" Immediate="true"></MudTextField>
            <MudTextField @bind-Value="profileFromTextBoxes.Password" T="string" Label="Password" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
            <MudTextField @bind-Value="profileFromTextBoxes.MasterFid" T="string" Label="MasterFid" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
            <MudTextField @bind-Value="profileFromTextBoxes.FID" T="string" Label="Fid" Variant="Variant.Outlined" Margin="Margin.Dense"></MudTextField>
            <MudSelect @ref="EnviromentField" @bind-Value="profileFromTextBoxes.WsdlAddress" T="WsdlAddress" Label="Select enviroment">
                @foreach (var wsdlAddres in Globals.WsdlAddresses)
                {
                    <MudSelectItem Value="wsdlAddres">@wsdlAddres.Name</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </MudPanel>
</MudItem>

    <MudDivider Class="mt-6 mx-4"/>
    
    <!-- Extended mode -->
    @if (ActiveMode == 1)
    {
        <MudItem xs="9">
            <CascadingValue Value="this">
                <AddressDetails package="package"/>
            </CascadingValue>
        </MudItem>

        <MudItem xs="3">
            <MudStack Row="true" Class="mb-4" Spacing="2">
                <MudText Typo="Typo.h5">Services</MudText>
                <MudToggleIconButton Size="Size.Small" @bind-Toggled="ServicesOn"
                                     Icon="@Icons.Material.Filled.ArrowDownward" ToggledIcon="@Icons.Material.Filled.ArrowUpward"/>
            </MudStack>
            <!-- Services -->
            @if (ServicesOn)
            {
                <MudPanel>
                    <MudGrid Class="pa-0">
                        <MudItem xs="6">
                            <MudStack Spacing="0">
                                <!-- Krajowa = international -->
                                <MudTooltip Arrow="true" Text="<cud/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.cud" Label="Return shipment" Disabled="package.International"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<rod/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.rod" Label="Return documents" Disabled="package.International"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<inPers/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.inPers" Label="Delivery to a dedicated person" Disabled="package.International || package.Services.dpdPickup"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<privPers/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.privPers" Label="B2C consignment" Disabled="package.Services.dpdPickup"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<dpdExpress/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.dpdExpress" Label="Air delivery" Disabled="!package.International || package.Services.pallet"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<pallet/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.pallet" Label="International pallet" Disabled="!package.International || package.Services.dpdExpress || package.Services.tiresExport"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<dox/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.dox" Label="Letter shipment" Disabled="package.International || package.Services.dpdLQ || package.Services.tires || package.Services.dpdFood || package.Services.carryIn"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<dpdLQ/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" Value="@package.Services.dpdLQ" Label="Shipment of dangerous goods" ValueChanged="DpdLQ" Disabled="package.Services.dox || package.Services.tires || package.Services.dpdFood"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<tires/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.tires" Label="Domestic tires" Disabled="@(package.International || package.Services.dpdLQ || package.Services.dox || package.Services.dpdPickup || package.Services.dpdFood || package.Services.Guarantee.type == "TIME0930" || package.Services.Guarantee.type == "TIME1200" || package.Services.Guarantee.type == "TIMEFIXED" || package.Services.Guarantee.type == "B2C" || package.Services.Guarantee.type == "DPDNEXTDAY" || package.Services.Guarantee.type == "DPDTODAY")" />
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<tiresExport/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.tiresExport" Label="Foreign tyres" Disabled="!package.International || package.Services.dpdExpress"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<digitalLabel/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.digitalLabel" Label="Send Parcel without a label" Disabled="package.International || package.Services.carryIn"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<pudoToSend/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.pudoToSend" Label="Sending a parcel at Pickup point" Disabled="package.International || package.Services.carryIn"/>
                                </MudTooltip>
                                <MudTooltip Arrow="true" Text="<carryIn/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.carryIn" Label="Carry-in" Disabled="package.International || package.Services.dox || package.Services.pudoToSend || package.Services.digitalLabel || package.Services.selfCol || package.Services.dpdPickup"/>
                                </MudTooltip>
                            </MudStack>
                        </MudItem>
                        
                        <MudItem xs="6">
                            <MudStack Spacing="0">
                                <MudTooltip Arrow="true" Text="<pudoToSend/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.declaredValue" Label="Declared value"/>
                                </MudTooltip>
                                @if (package.Services.declaredValue)
                                {
                                    <MudSelect T="Currency" @bind-Value="@package.Services.DeclaredValue.currency" Label="Currency" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        @foreach (var currency in Globals.Currencies.Where(c => c.IsDeclaredAmount))
                                        {
                                            <MudSelectItem Value="@currency">@currency.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <MudTextField Label="Amount" @bind-Value="@package.Services.DeclaredValue.amount" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                                }

                                <MudTooltip Arrow="true" Text="<cod/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.cod" Label="Cash on delivery (COD)"/>
                                </MudTooltip>
                                @if (package.Services.cod)
                                {
                                    <MudSelect T="Currency" @bind-Value="@package.Services.Cod.currency" Label="Currency" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        @foreach (var currency in Globals.Currencies.Where(c => c.IsCod))
                                        {
                                            <MudSelectItem Value="@currency">@currency.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <MudTextField Label="Cash amount" @bind-Value="@package.Services.Cod.amount" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                                }

                                <MudTooltip Arrow="true" Text="<dpdPickup/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.dpdPickup" Label="Delivery to the Pickup Point" Disabled="package.Services.tires || package.Services.privPers || package.Services.inPers || package.Services.guarantee || package.Services.dpdFood || package.Services.selfCol || package.Services.carryIn"/>
                                </MudTooltip>
                                @if (package.Services.dpdPickup)
                                {
                                    <MudTextField Label="Point ID" @bind-Value="@package.Services.DpdPickup.pudo" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                                }

                                <MudTooltip Arrow="true" Text="<duty/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.duty" Label="Customs clearance service" Disabled="!package.International"/>
                                </MudTooltip>
                                @if (package.Services.duty)
                                {
                                    <MudSelect T="Currency" @bind-Value="@package.Services.Duty.currency" Label="Currency" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        @foreach (var currency in Globals.Currencies.Where(c => c.IsDuty))
                                        {
                                            <MudSelectItem Value="@currency">@currency.Name</MudSelectItem>
                                        }
                                    </MudSelect>
                                    <MudTextField Label="Cash amount" @bind-Value="@package.Services.Duty.amount" Variant="Variant.Outlined" Margin="Margin.Dense"/>
                                }

                                <MudTooltip Arrow="true" Text="<selfCol/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.selfCol" Label="Personal collection" Disabled="package.International || package.Services.carryIn || package.Services.dpdPickup"/>
                                </MudTooltip>
                                @if (package.Services.selfCol)
                                {
                                    <MudSelect T="string" @bind-Value="@package.Services.SelfCol.receiver" Label="Receiver" Variant="Variant.Outlined" Margin="Margin.Dense" Required="true">
                                        <MudSelectItem T="string" Value="@("PRIV")">Private</MudSelectItem>
                                        <MudSelectItem T="string" Value="@("COMP")">Company</MudSelectItem>
                                    </MudSelect>
                                }

                                <MudTooltip Arrow="true" Text="<dpdFood/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.dpdFood" Label="Food delivery" Disabled="package.International || package.Services.tires || package.Services.dox || package.Services.dpdLQ || package.Services.dpdPickup"/>
                                </MudTooltip>
                                @if (package.Services.dpdFood)
                                {
                                    <MudTextField @bind-Value="@package.Services.DpdFood.limitDate" T="DateTime" Format="yyyy-MM-dd" Margin="Margin.Dense" Variant="Variant.Outlined" Label="Limit Date" InputType="InputType.Date"/>
                                }

                                <MudTooltip Arrow="true" Text="<guarentee/>" Placement="Placement.Top" Color="Color.Info">
                                    <MudCheckBox Dense="true" T="bool" @bind-Value="@package.Services.guarantee" Label="Guarantee" Disabled="package.Services.dpdPickup"/>
                                </MudTooltip>
                                @if (package.Services.guarantee)
                                {
                                    <MudSelect T="string" @bind-Value="@package.Services.Guarantee.type" Label="Type" Variant="Variant.Outlined" Margin="Margin.Dense">
                                        <MudSelectItem Value="@("TIME0930")" Disabled="package.International || package.Services.tires">Delivery at 9:30</MudSelectItem>
                                        <MudSelectItem Value="@("TIME1200")" Disabled="package.International || package.Services.tires">Delivery at 12:00</MudSelectItem>
                                        <MudSelectItem Value="@("SATURDAY")" Disabled="package.International">Delivery on saturday</MudSelectItem>
                                        <MudSelectItem Value="@("TIMEFIXED")" Disabled="package.International || package.Services.tires">Delivery at given hour</MudSelectItem>
                                        <MudSelectItem Value="@("B2C")" Disabled="package.International || package.Services.tires">Bussiness to customer</MudSelectItem>
                                        <MudSelectItem Value="@("DPDNEXTDAY")" Disabled="package.International || package.Services.tires">Delivery next day</MudSelectItem>
                                        <MudSelectItem Value="@("DPDTODAY")" Disabled="package.International || package.Services.tires || package.Services.carryIn">Delivery Today</MudSelectItem>
                                        <MudSelectItem Value="@("INTER")" Disabled="!package.International">International Guarantee</MudSelectItem>
                                    </MudSelect>
                                    @if (package.Services.Guarantee.type is not null && (package.Services.Guarantee.type == "B2C" || package.Services.Guarantee.type == "TIMEFIXED"))
                                    {
                                        <MudTextField @bind-Value="@package.Services.Guarantee.value" T="string" Margin="Margin.Dense" Variant="Variant.Outlined" Label="Time of delivery"/>
                                    }
                                }
                            </MudStack>
                        </MudItem>
                    </MudGrid>
                </MudPanel>
            }
        </MudItem>

        <MudDivider Class="mt-4 mx-4"/>
        <MudItem xs="3">
            <MudStack Row="true" Class="mb-4" Spacing="2">
                <MudText Typo="Typo.h5" Class="mb-2">Additional details</MudText>
                <MudToggleIconButton Size="Size.Small" @bind-Toggled="DetailsOn"
                                     Icon="@Icons.Material.Filled.ArrowDownward" ToggledIcon="@Icons.Material.Filled.ArrowUpward"/>
            </MudStack>
            @if (DetailsOn)
            {
                <MudPanel>
                    <MudStack>
                        <MudTextField Margin="Margin.Dense" @bind-Value="package.Ref1" Label="ref1" Variant="Variant.Outlined"/>
                        <MudTextField Margin="Margin.Dense" @bind-Value="package.Ref2" Label="ref2" Variant="Variant.Outlined"/>
                        <MudTextField Margin="Margin.Dense" @bind-Value="package.Ref3" Label="ref3" Variant="Variant.Outlined"/>
                    </MudStack>
                </MudPanel>
            }
        </MudItem>
        
        <MudItem xs="9">
            <MudStack Row="true" Class="mb-4" Spacing="2">
                <MudText Typo="Typo.h5" Class="mb-2">Parcels</MudText>
                <MudToggleIconButton Size="Size.Small" @bind-Toggled="ParcelsOn"
                                     Icon="@Icons.Material.Filled.ArrowDownward" ToggledIcon="@Icons.Material.Filled.ArrowUpward"/>
            </MudStack>
            @if (ParcelsOn)
            {
                <CascadingValue Value="package.Services.dpdLQ">
                    <CascadingValue Value="package.Parcels">
                        <ParcelsTable/>
                    </CascadingValue>
                </CascadingValue>
            }
        </MudItem>
        
        <MudDivider Class="mt-4 mx-4"/>
    }

    <MudItem xs="3">
        <MudStack>
            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Send" Color="Color.Primary" OnClick="GenerateLabel">
                @if (_processingLabel)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Generate Label</MudText>
                }
            </MudButton>
            <MudButton Variant="Variant.Filled" EndIcon="@Icons.Material.Filled.Send" Color="Color.Primary" OnClick="GenerateProtocol" Disabled="@(package.Base64Label is null)">
                @if (_processingProtocol)
                {
                    <MudProgressCircular Class="ms-n1" Size="Size.Small" Indeterminate="true"/>
                    <MudText Class="ms-2">Processing</MudText>
                }
                else
                {
                    <MudText>Generate Protocol</MudText>
                }
            </MudButton>
            <!-- Tracking links -->
            @if (package.Parcels.Count > 0)
            {
                <MudPanel>
                    <MudTable Items="@TrackingLinks" Breakpoint="Breakpoint.Sm">
                        <HeaderContent>
                            <MudTh>Waybill</MudTh>
                            <MudTh>GeoPost</MudTh>
                            <MudTh>TrackTrace</MudTh>
                        </HeaderContent>
                        <RowTemplate>
                            <MudTd DataLabel="Waybill" Style="font-size: 0.9vw">@context.waybill</MudTd>
                            <MudTd DataLabel="GeoPost">
                                <MudLink Style="font-size: 0.9vw" Target="_blank" Href="@context.getGeoPostLink()">GeoPost</MudLink>
                            </MudTd>
                            <MudTd DataLabel="TrackTrace">
                                <MudLink Style="font-size: 0.9vw" Target="_blank" Href="@context.getTrackTraceLink()">TrackTrace</MudLink>
                            </MudTd>
                        </RowTemplate>
                    </MudTable>
                </MudPanel>
            }
            else
            {
                <MudCard>
                    <MudCardContent Style="text-align: center">
                        <h3>Tracking</h3>
                    </MudCardContent>
                </MudCard>
            }
        </MudStack>
    </MudItem>
    
    @if (Errors.Count == 0)
    {
        <MudItem xs="4">
            @if (package.Base64Label is not null)
            {
                <MudCard style="height:750px" Elevation="2">
                    <MudCardContent>
                        <iframe width="100%" height="100%" src="data:application/pdf;base64,@package.Base64Label" frameborder="0"></iframe>
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <MudCard>
                    <MudCardContent Style="text-align: center" Elevation="2">
                        <h3>Label</h3>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
        <MudItem xs="5">
            @if (package.Base64Protocol is not null)
            {
                <MudCard style="height:750px" Elevation="2">
                    <MudCardContent>
                        <iframe width="100%" height="100%" src="data:application/pdf;base64,@package.Base64Protocol" frameborder="0"></iframe>
                    </MudCardContent>
                </MudCard>
            }
            else
            {
                <MudCard>
                    <MudCardContent Style="text-align: center" Elevation="2">
                        <h3>Protocol</h3>
                    </MudCardContent>
                </MudCard>
            }
        </MudItem>
    }
    else
    {
        <MudItem xs="9">
            <ErrorsList Errors="Errors" />
        </MudItem>
    }
</MudGrid>

@code {
    Profile profileFromTextBoxes = new Profile();
    Profile _currentProfile;
    
    MudTextField<string>? ReceiverPostalCodeField;
    MudSelect<WsdlAddress>? EnviromentField;
    
    private bool _processingLabel = false;
    private bool _processingProtocol = false;
    private bool _refreshing = false;
    
    [CascadingParameter]
    public Profile CurrentProfile
    {
        get => _currentProfile;
        set
        {
            _currentProfile = value;
            UpdateCredentials(_currentProfile);
        }
    }

    public List<SoapError> Errors
    {
        get => AppState.GenerateLabelsState.Errors;
        set => AppState.GenerateLabelsState.Errors = value;
    }

    public bool ServicesOn
    {
        get => AppState.GenerateLabelsState.ServicesOn;
        set => AppState.GenerateLabelsState.ServicesOn = value;
    }

    public bool DetailsOn
    {
        get => AppState.GenerateLabelsState.DetailsOn;
        set => AppState.GenerateLabelsState.DetailsOn = value;
    }

    public bool ParcelsOn
    {
        get => AppState.GenerateLabelsState.ParcelsOn;
        set => AppState.GenerateLabelsState.ParcelsOn = value;
    }

    public int ActiveMode
    {
        get => AppState.GenerateLabelsState.ActiveMode;
        set => AppState.GenerateLabelsState.ActiveMode = value;
    }

    public List<TrackingLinkService> TrackingLinks
    {
        get => AppState.GenerateLabelsState.TrackingLinks;
        set => AppState.GenerateLabelsState.TrackingLinks = value;
    }

    Package package
    {
        get => AppState.GenerateLabelsState.package;
        set => AppState.GenerateLabelsState.package = value;
    }

    protected override Task OnInitializedAsync()
    {
        AppState.CurrentPage = "Generate Labels";
        return base.OnInitializedAsync();
    }

    protected override Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender)
        {
            UpdateCredentials(CurrentProfile);
        }
        return base.OnAfterRenderAsync(firstRender);
    }

    async Task GenerateLabel()
    {
        _processingLabel = true;
        Errors.Clear();
        package.Base64Protocol = null;
        package.Base64Label = null;
        TrackingLinks.Clear();

        try
        {
            package.ThirdPartyFID = profileFromTextBoxes.FID;
            await package.GenerateWaybills(profileFromTextBoxes);
        }
        catch (SoapException e)
        {
            foreach (var soapError in e.Errors)
            {
                Errors.Add(soapError);
            }
            _processingLabel = false;
            return;
        }

        foreach (var parcel in package.Parcels)
        {
            TrackingLinks.Add(new TrackingLinkService(parcel.Waybill));
        }
        
        if (AppState.Settings.SaveLabelsToFile) FileService.SaveBase64ToPDF(package.Base64Label, PrintType.Label);
        
        _processingLabel = false;
    }

    private async Task GenerateProtocol(MouseEventArgs obj)
    {
        _processingProtocol = true;
        try
        {
            await package.GenerateProtocol(profileFromTextBoxes);
        }
        catch (SoapException e)
        {
            foreach (var soapError in e.Errors)
            {
                Errors.Add(soapError);
            }
            _processingProtocol = false;
            return;
        }

        if (AppState.Settings.SaveProtocolsToFile) FileService.SaveBase64ToPDF(package.Base64Protocol, PrintType.Protocol);
        _processingProtocol = false;
    }

    //Infer masterfid/fid from login
    private void LoginChanged(string login)
    {
        if (Regex.IsMatch(login, "01$"))
        {
            var fid = login[..^2];
            profileFromTextBoxes.MasterFid = fid;
            profileFromTextBoxes.FID = fid;
        }
        profileFromTextBoxes.Login = login;
        StateHasChanged();
    }

    private void UpdateCredentials(Profile profile)
    {
        profileFromTextBoxes.Login = profile.Login;
        profileFromTextBoxes.Password = profile.Password;
        profileFromTextBoxes.MasterFid = profile.MasterFid;
        profileFromTextBoxes.FID = profile.FID;
        profileFromTextBoxes.WsdlAddress = profile.WsdlAddress;
        if (EnviromentField != null) EnviromentField.Value = profileFromTextBoxes.WsdlAddress;
        StateHasChanged();
    }
    
    private void DpdLQ(bool obj)
    {
        if (!obj)
        {
            foreach (var parcel in package.Parcels)
            {
                parcel.AdrWeight = null;
            }   
        }
        package.Services.dpdLQ = obj;
        StateHasChanged();
    }
    
    public void RefreshState(){
        this.StateHasChanged();
    }

    private void RefreshData()
    {
        _refreshing = true;
        package = new Package();
        TrackingLinks.Clear();
        Errors.Clear();
        _refreshing = false;
        StateHasChanged();
    }
    
    //TODO Debug this
    private async void OnEnter(KeyboardEventArgs e)
    {
        if (e.Code == "Enter" || e.Code == "NumpadEnter")
        {
            await GenerateLabel();
        }
    }
}