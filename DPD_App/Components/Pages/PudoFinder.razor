@page "/PudoFinder"
@using MudBlazor.Interfaces
@inject AppState AppState

<PageTitle>PudoFinder</PageTitle>

<h1 class="pa-1 pb-3">PudoFinder</h1>

<MudGrid Style="align-items: center;">
    
    <MudItem xs="3" Class="justify-center">
        <MudStack>
            <!-- Key input -->
            <MudTextField Immediate="true" Value="key" T="string" Label="Widget Key" Variant="Variant.Outlined" TextChanged="OnKeyChanged"/>

            <!-- Country select -->
            <MudSelect T="Country" Value="SelectedCountry" Variant="Variant.Outlined" Label="Select country" ValueChanged="OnCountrySelect">
                @foreach (Country item in Globals.Countries)
                {
                    <MudSelectItem Value="@item">@item.Name</MudSelectItem>
                }
            </MudSelect>
        </MudStack>
    </MudItem>

    <MudItem xs="9">
        <MudStack Row="true" Justify="Justify.Center" Wrap="Wrap.Wrap">
            @foreach (var filter in Globals.MapFilters)
            {
                <MudPaper Class="pr-3">
                    <MudCheckBox T="bool" Value="@filter.IsActive" Label="@filter.Name"ValueChanged="b => { filter.IsActive = b; updateQuery(); StateHasChanged();}" />
                </MudPaper>
            }
        </MudStack>
    </MudItem>

    <!-- Query text -->
    <MudItem xs="12">
        <MudDivider DividerType="DividerType.Middle" Class="mt-0 mb-6"/>
        <MudTextField @ref="QueryBox" @bind-Value="Query" Label="Query" Variant="Variant.Outlined"
                      Adornment="Adornment.End" AdornmentIcon="@Icons.Material.Filled.Api" OnAdornmentClick="@(() => QueryBox?.SelectAsync())"/>
    </MudItem>
    
    <MudItem xs="12">
        @if (Query is not null)
        {
            <MudCard style="height:750px">
                <MudCardContent>
                    <iframe width="100%" height="100%" src="@Query" frameborder="0" allow="geolocation *"></iframe>
                </MudCardContent>
            </MudCard>
        }
        else
        {
            <MudCard>
                <MudCardContent>
                    <MudText>Map widget</MudText>
                </MudCardContent>
            </MudCard>
        }
    </MudItem>
</MudGrid>

@code {
    [CascadingParameter] public Profile CurrentProfile { get; set; }
    private MudTextField<string>? QueryBox;

    public Country? SelectedCountry
    {
        get => AppState.PudoFinderState.SelectedCountry;
        set => AppState.PudoFinderState.SelectedCountry = value;
    }

    public string? Query { get; set; }
    
    private string? key;

    protected override Task OnInitializedAsync()
    {
        key = CurrentProfile.WidgetKey;
        return base.OnInitializedAsync();
    }

    private void OnCountrySelect(Country obj)
    {
        SelectedCountry = obj;
        updateQuery();
    }
    
    private void OnKeyChanged(string obj)
    {
        key = obj;
        updateQuery();
    }

    public void updateQuery()
    {
        string query = $"//pudofinder.dpd.com.pl/widget?";
        
        if (key is not null)
        {
            query += $"key={key}";
        }

        if (SelectedCountry is not null)
        {
            query += $"&query={SelectedCountry.IsoCodeA2}";
        }
        
        foreach (var mapFilter in Globals.MapFilters)
        {
            if (mapFilter.IsActive)
            {
                query += "&" + mapFilter.Value + "=1";
            }
        }
        
        Query = query;
        StateHasChanged();
    }
    
}